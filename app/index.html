<html>
<head>
<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
<script src='http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js'></script>
<script src='http://datejs.googlecode.com/svn/trunk/build/date.js'></script>
<script>
$(document).ready(function(){
  if (typeof(WebSocket) != 'undefined' || typeof(MozWebSocket)) {
    $('#ask').show();
  } else {
    $('#error').show();
  }
  
  // join on enter
  $('#ask input').keydown(function(event) {
    if (event.keyCode == 13) {
      $('#ask a').click();
    }
  })
  
  // join on click
  $('#ask a').click(function() {
    join($('#ask input').val());
    $('#ask').hide();
    $('#application').show();
    $('input#message').focus();
  });

  function join(name) {
    var host = window.location.host.split(':')[0];

    var SocketKlass = "MozWebSocket" in window ? MozWebSocket : WebSocket;
    var ws = new SocketKlass('ws://127.0.0.1:3000/websocket/readme');

    var container = $('div#msgs');
    ws.onmessage = function(evt) {
      var obj = $.evalJSON(evt.data);
      if (typeof obj != 'object') return;

      var action = obj['action'];
      var struct = container.find('li.' + action + ':first');
      if (struct.length < 1) {
        console.log("Could not handle: " + evt.data);
        return;
      }
      
      var msg = struct.clone();
      msg.find('.time').text((new Date()).toString("HH:mm:ss"));

      if (action == 'message') {
        var matches;
        if (matches = obj['message'].match(/^\s*[\/\\]me\s(.*)/)) {
          msg.find('.user').text(obj['user'] + ' ' + matches[1]);
          msg.find('.user').css('font-weight', 'bold');
        } else {
          msg.find('.user').text(obj['user']);
          msg.find('.message').text(': ' + obj['message']);
        }
      } else if (action == 'control') {
        msg.find('.user').text(obj['user']);
        msg.find('.message').text(obj['message']);
        msg.addClass('control');
      }
      
      if (obj['user'] == name) msg.find('.user').addClass('self');
      container.find('ul').append(msg.show());
      container.scrollTop(container.find('ul').innerHeight());
    }
    
    $('#channel form').submit(function(event) {
      event.preventDefault();
      var input = $(this).find(':input');
      var msg = input.val();
      ws.send($.toJSON({ action: 'message', message: msg }));
      input.val('');
    });
    
    // send name when joining
    ws.onopen = function() {
      ws.send($.toJSON({ action: 'join', user: name }));
    }
  }


  function getCaretPosition(editableDiv) {
      var caretPos = 0, containerEl = null, sel, range;
      if (window.getSelection) {
          sel = window.getSelection();
          if (sel.rangeCount) {
              range = sel.getRangeAt(0);
              if (range.commonAncestorContainer.parentNode == editableDiv) {
                  caretPos = range.endOffset;
              }
          }
      } else if (document.selection && document.selection.createRange) {
          range = document.selection.createRange();
          if (range.parentElement() == editableDiv) {
              var tempEl = document.createElement("span");
              editableDiv.insertBefore(tempEl, editableDiv.firstChild);
              var tempRange = range.duplicate();
              tempRange.moveToElementText(tempEl);
              tempRange.setEndPoint("EndToEnd", range);
              caretPos = tempRange.text.length;
          }
      }
      return caretPos;
  }

  $('#editor').bind('keyup click', function() {

    var offset = getCaretPosition(this),
        $org = $(this),
        $el = $org.clone(),
        char = $el.text().substr(offset-1, 1);
    
    console.log(offset, char);

      var html = '<span class="ins_str">' + char + '</span>';
      $el.html($el.text().substr(0, offset - 1) + html + $el.text().substr(offset));
  
      var x = $org.offset().left,
          y = $org.offset().top,
          width = $org.outerWidth() - 22,
          height = $org.outerHeight() - 22;
  
      $el.css({
          'position': 'absolute',
          'top': y,
          'left': x,
          'width': width,
          'height': height,
          'opacity': 0
      });
      $org.before($el);
  
      var $span = $el.find('span.ins_str');
      if ($span.length > 0)
      {
          var offset = $span.offset(),
              char_x = offset.left - $(this).scrollLeft(),
              char_y = offset.top - $(this).scrollTop();
  
          $('div#cursor').css({
              'left': char_x,
              'top': char_y
          });
      }
      
      console.log($span.offset(), $span.position());
  
      $el.remove();   
  }); 
});
</script>
<style type="text/css" media="screen">
  * {
    font-family: Georgia;
  }
  a {
    color: #000;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  div.bordered {
    margin: 0 auto;
    margin-top: 100px;
    width: 600px;
    padding: 20px;
    text-align: center;
    border: 10px solid #ddd;
    -webkit-border-radius: 20px;
  }
  div.bordered-clean {
    padding: 10px;
    border: 10px solid #ddd;
    -webkit-border-radius: 20px;
  }
  #error {
    background-color: #BA0000;
    color: #fff;
    font-weight: bold;
  }
  #ask {
    font-size: 20pt;
    text-align: left;
    width: 530px;
  }
  #ask input {
    font-size: 20pt;
    padding: 5px;
    margin: 5px 10px;
  }
  #ask label {
    display: inline-block;
    width: 100px;
  }
  #ask span.join {
    padding: 10px;
    padding-top: 40px;
    background-color: #ddd;
    -webkit-border-radius: 10px;
    float: right;
    height: 60px;
  }
  div#msgs {
    overflow-y: scroll;
    height: 440px;
  }
  div#msgs ul {
    list-style: none;
    padding: 0;
    margin: 0;
    text-align: left;
  }
  div#msgs li {
    line-height: 20px;
  }
  div#msgs li span.user {
    color: #ff9900;
  }
  div#msgs li span.user.self {
    color: #aa2211;
  }
  div#msgs li span.time {
    float: right;
    margin-right: 5px;
    color: #aaa;
    font-family: "Courier New";
    font-size: 12px;
  }
  div#msgs li.control {
    text-align: center;
  }
  div#msgs li.control span.message {
    color: #aaa;
  }
  div#input {
    text-align: left;
    margin-top: 20px;
  }
  div#input #message {
    width: 300px;
    border: 5px solid #bbb;
    -webkit-border-radius: 3px;
    font-size: 12pt;
    padding: 5px;
  }

  #application {
    width: 1000px;
    margin: 20px auto;
  }
  #editor {
    float: left;
    width: 600px;
    height: 500px;
    font-size: 10pt;
  }
  #channel {
    float: right;
    height: 500px;
    width: 300px;
  }

  div#mycursor {
    display: block;
    width: 5px;
    height: 18px;
    background: red;
    position: absolute;
    top: 0;
    left: 0;
}
span.ins_str {
/*position: relative;
    display: inline-block;*/
    color: red;
}
</style>
</head>
<body>
  <div id="error" class="bordered" style="display: none;">
    This browser has no native WebSocket support.
  </div>
  <div id="ask" class="bordered" style="display: none;">
    <a href="#"><span class="join">Join!</span></a>
    <label>Name:</label> <input type="text" id="name" /> <br />
    <label>File:</label> <input type="text" id="name" />
  </div>
  <div id="application"  style="display: none;">
      <div id="editor" class="bordered-clean" contenteditable="true">
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
<br /><br />
Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
<br /><br />
Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
      </div>
    <div id="mycursor"></div>

    <div id="channel" class="bordered-clean">
      <div id="msgs">
        <ul>
          <li class="message" style="display: none">
            <span class="user"></span><span class="message"></span>
            <span class="time"></span>
          </li>
          <li class="control" style="display: none">
            <span class="user"></span>&nbsp;<span class="message"></span>
            <span class="time"></span>
          </li>
        </ul>
      </div>
      <div id="input">
        <form><input type="text" id="message" /></form>
      </div>
    </div>
  </div>
</body>
</html>
